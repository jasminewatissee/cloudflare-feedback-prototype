<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Feedback Aggregation Dashboard</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			padding: 20px;
			color: #333;
		}
		
		.container {
			max-width: 1200px;
			margin: 0 auto;
		}
		
		header {
			background: white;
			border-radius: 12px;
			padding: 30px;
			margin-bottom: 30px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}
		
		h1 {
			color: #667eea;
			margin-bottom: 10px;
			font-size: 2.5em;
		}
		
		.subtitle {
			color: #666;
			font-size: 1.1em;
		}
		
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}
		
		.stat-card {
			background: white;
			border-radius: 12px;
			padding: 20px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			text-align: center;
		}
		
		.stat-value {
			font-size: 2.5em;
			font-weight: bold;
			color: #667eea;
			margin-bottom: 5px;
		}
		
		.stat-label {
			color: #666;
			font-size: 0.9em;
			text-transform: uppercase;
			letter-spacing: 1px;
		}
		
		.section {
			background: white;
			border-radius: 12px;
			padding: 30px;
			margin-bottom: 30px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		}
		
		.section-title {
			font-size: 1.8em;
			color: #333;
			margin-bottom: 20px;
			padding-bottom: 10px;
			border-bottom: 2px solid #f0f0f0;
		}
		
		.summary-card {
			background: #f8f9fa;
			border-radius: 8px;
			padding: 20px;
			margin-bottom: 20px;
			border-left: 4px solid #667eea;
		}
		
		.summary-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
		}
		
		.summary-source {
			font-weight: bold;
			color: #667eea;
			font-size: 1.1em;
			text-transform: capitalize;
		}
		
		.summary-meta {
			color: #666;
			font-size: 0.9em;
		}
		
		.summary-content {
			color: #333;
			line-height: 1.6;
			white-space: pre-wrap;
		}
		
		.aggregated-summary {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border-radius: 8px;
			padding: 25px;
			margin-bottom: 20px;
		}
		
		.aggregated-summary .summary-content {
			color: white;
			font-size: 1.05em;
			line-height: 1.8;
		}
		
		.loading {
			text-align: center;
			padding: 40px;
			color: #666;
		}
		
		.error {
			background: #fee;
			border: 1px solid #fcc;
			border-radius: 8px;
			padding: 15px;
			color: #c33;
			margin-bottom: 20px;
		}
		
		.refresh-btn {
			background: #667eea;
			color: white;
			border: none;
			border-radius: 8px;
			padding: 12px 24px;
			font-size: 1em;
			cursor: pointer;
			margin-top: 20px;
			transition: background 0.3s;
		}
		
		.refresh-btn:hover {
			background: #5568d3;
		}
		
		.source-filter {
			display: flex;
			gap: 10px;
			margin-bottom: 20px;
			flex-wrap: wrap;
		}
		
		.filter-btn {
			background: #f0f0f0;
			border: 2px solid transparent;
			border-radius: 20px;
			padding: 8px 16px;
			cursor: pointer;
			transition: all 0.3s;
			text-transform: capitalize;
		}
		
		.filter-btn:hover {
			background: #e0e0e0;
		}
		
		.filter-btn.active {
			background: #667eea;
			color: white;
			border-color: #667eea;
		}
		
		.empty-state {
			text-align: center;
			padding: 60px 20px;
			color: #999;
		}
		
		.empty-state-icon {
			font-size: 4em;
			margin-bottom: 20px;
		}
	</style>
</head>
<body>
	<div class="container">
		<header>
			<h1>üìä Feedback Aggregation Dashboard</h1>
			<p class="subtitle">Aggregated insights from all feedback sources</p>
		</header>
		
		<div class="stats-grid" id="statsGrid">
			<div class="stat-card">
				<div class="stat-value" id="totalFeedback">-</div>
				<div class="stat-label">Total Feedback</div>
			</div>
			<div class="stat-card">
				<div class="stat-value" id="totalSources">-</div>
				<div class="stat-label">Sources</div>
			</div>
			<div class="stat-card">
				<div class="stat-value" id="latestAggregated">-</div>
				<div class="stat-label">Latest Aggregation</div>
			</div>
		</div>
		
		<div class="section">
			<h2 class="section-title">üéØ Aggregated Summary</h2>
			<div id="aggregatedSection">
				<div class="loading">Loading aggregated summaries...</div>
			</div>
		</div>
		
		<div class="section">
			<h2 class="section-title">üìù Source Summaries</h2>
			<div class="source-filter" id="sourceFilter">
				<button class="filter-btn active" data-source="all">All Sources</button>
			</div>
			<div id="sourceSummariesSection">
				<div class="loading">Loading source summaries...</div>
			</div>
		</div>
		
		<div style="text-align: center;">
			<button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>
		</div>
	</div>
	
	<script>
		let currentSourceFilter = 'all';
		let allSummaries = [];
		
		async function loadData() {
			try {
				// Load stats
				const statsResponse = await fetch('/api/stats');
				const stats = await statsResponse.json();
				
				if (stats.success) {
					updateStats(stats);
				}
				
				// Load aggregated summaries
				const aggResponse = await fetch('/api/aggregated?limit=1');
				const aggData = await aggResponse.json();
				
				if (aggData.success) {
					displayAggregated(aggData.summaries);
				}
				
				// Load source summaries
				const summariesResponse = await fetch('/api/summaries');
				const summariesData = await summariesResponse.json();
				
				if (summariesData.success) {
					allSummaries = summariesData.summaries;
					updateSourceFilter(allSummaries);
					displaySourceSummaries(allSummaries);
				}
			} catch (error) {
				console.error('Error loading data:', error);
				document.getElementById('aggregatedSection').innerHTML = 
					'<div class="error">Error loading data. Please try again.</div>';
				document.getElementById('sourceSummariesSection').innerHTML = 
					'<div class="error">Error loading data. Please try again.</div>';
			}
		}
		
		function updateStats(stats) {
			// Calculate total feedback
			let totalFeedback = 0;
			if (stats.feedbackCountsBySource) {
				totalFeedback = stats.feedbackCountsBySource.reduce((sum, item) => sum + (item.count || 0), 0);
			}
			
			// Count unique sources
			const sourceCount = stats.feedbackCountsBySource ? stats.feedbackCountsBySource.length : 0;
			
			// Latest aggregated date
			let latestDate = 'Never';
			if (stats.latestAggregatedSummary) {
				const date = new Date(stats.latestAggregatedSummary.created_at * 1000);
				latestDate = date.toLocaleDateString();
			}
			
			document.getElementById('totalFeedback').textContent = totalFeedback.toLocaleString();
			document.getElementById('totalSources').textContent = sourceCount;
			document.getElementById('latestAggregated').textContent = latestDate;
		}
		
		function displayAggregated(summaries) {
			const section = document.getElementById('aggregatedSection');
			
			if (!summaries || summaries.length === 0) {
				section.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No aggregated summaries yet. Check back after the next scheduled aggregation.</p></div>';
				return;
			}
			
			const latest = summaries[0];
			const dateRange = `${new Date(latest.date_range_start * 1000).toLocaleDateString()} - ${new Date(latest.date_range_end * 1000).toLocaleDateString()}`;
			
			section.innerHTML = `
				<div class="aggregated-summary">
					<div class="summary-header">
						<div class="summary-source">Latest Aggregation</div>
						<div class="summary-meta">${dateRange} ‚Ä¢ ${latest.source_count} sources ‚Ä¢ ${latest.total_feedback_count} items</div>
					</div>
					<div class="summary-content">${latest.summary}</div>
				</div>
			`;
		}
		
		function updateSourceFilter(summaries) {
			const sources = [...new Set(summaries.map(s => s.source))];
			const filterContainer = document.getElementById('sourceFilter');
			
			// Keep "All Sources" button and add source buttons
			filterContainer.innerHTML = '<button class="filter-btn active" data-source="all" onclick="filterBySource(\'all\')">All Sources</button>';
			
			sources.forEach(source => {
				const btn = document.createElement('button');
				btn.className = 'filter-btn';
				btn.textContent = source;
				btn.setAttribute('data-source', source);
				btn.onclick = () => filterBySource(source);
				filterContainer.appendChild(btn);
			});
		}
		
		function filterBySource(source) {
			currentSourceFilter = source;
			
			// Update button states
			document.querySelectorAll('.filter-btn').forEach(btn => {
				if (btn.getAttribute('data-source') === source) {
					btn.classList.add('active');
				} else {
					btn.classList.remove('active');
				}
			});
			
			// Filter and display summaries
			const filtered = source === 'all' 
				? allSummaries 
				: allSummaries.filter(s => s.source === source);
			
			displaySourceSummaries(filtered);
		}
		
		function displaySourceSummaries(summaries) {
			const section = document.getElementById('sourceSummariesSection');
			
			if (!summaries || summaries.length === 0) {
				section.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No source summaries available yet.</p></div>';
				return;
			}
			
			section.innerHTML = summaries.map(summary => {
				const dateRange = `${new Date(summary.date_range_start * 1000).toLocaleDateString()} - ${new Date(summary.date_range_end * 1000).toLocaleDateString()}`;
				const createdDate = new Date(summary.created_at * 1000).toLocaleString();
				
				return `
					<div class="summary-card">
						<div class="summary-header">
							<div class="summary-source">${summary.source}</div>
							<div class="summary-meta">${dateRange} ‚Ä¢ ${summary.feedback_count} items ‚Ä¢ ${createdDate}</div>
						</div>
						<div class="summary-content">${summary.summary}</div>
					</div>
				`;
			}).join('');
		}
		
		// Load data on page load
		loadData();
		
		// Auto-refresh every 5 minutes
		setInterval(loadData, 5 * 60 * 1000);
	</script>
</body>
</html>
